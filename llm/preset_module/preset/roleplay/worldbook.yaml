# 世界书/设定管理 - Worldbook/Lorebook Management
# 用途：管理复杂世界观设定，处理设定冲突
# 推荐度：⭐⭐⭐

# === 世界书系统说明 ===

- system: |
    <worldbook_system>
    世界书（Worldbook/Lorebook）用于管理复杂设定：

    什么是世界书：
    - 存储世界观、设定、背景信息的数据库
    - 包含地点、人物、物品、历史等
    - 在特定关键词触发时自动插入
    - 避免重复描述，节省token

    世界书的优势：
    - 设定集中管理
    - 自动触发，无需手动输入
    - 保持设定一致性
    - 便于扩展和修改

    典型内容：
    - 地点描述
    - 角色背景
    - 物品说明
    - 历史事件
    - 世界规则
    - 专有名词解释
    </worldbook_system>

# === 设定优先级管理 ===

- system: |
    <setting_priority>
    当多个设定源产生冲突时的优先级：

    优先级从高到低：
    1. 角色卡（Character Card）
       - 当前对话的主角设定
       - 最高优先级
       - 不可被覆盖

    2. 场景设定（Scenario）
       - 当前场景的特殊设定
       - 可以临时覆盖世界书
       - 场景结束后失效

    3. 世界书主条目（Main Lorebook）
       - 核心世界观设定
       - 适用于整个世界
       - 相对稳定

    4. 世界书扩展条目（Extended Lorebook）
       - 补充信息
       - 可选内容
       - 优先级最低

    5. 预设（Preset）
       - 系统级设定
       - 不涉及具体内容
       - 最底层

    冲突解决原则：
    - 高优先级覆盖低优先级
    - 具体覆盖抽象
    - 近期覆盖远期
    - 明确说明的覆盖模糊的
    </setting_priority>

# === 世界书条目结构 ===

- system: |
    <worldbook_entry_structure>
    标准世界书条目的结构：

    【条目模板】
    名称：${条目名称}
    关键词：${触发词1}, ${触发词2}, ${触发词3}
    类型：${地点/人物/物品/事件/概念}
    优先级：${高/中/低}

    内容：
    ${简洁的描述，通常50-200字}

    示例1：地点条目
    名称：银月城
    关键词：银月城, 银月, 首都
    类型：地点
    优先级：中

    内容：
    银月城是王国的首都，位于月光湖畔。城市以银色的城墙和水晶塔闻名。人口约50万。主要产业是魔法研究和贸易。

    示例2：人物条目
    名称：艾琳娜（背景）
    关键词：艾琳娜, Elena
    类型：人物背景
    优先级：高

    内容：
    艾琳娜，27岁，魔法学院教授。专长是元素魔法。10年前失去了妹妹，从此专注于研究复活魔法。性格冷静但内心温柔。

    示例3：概念条目
    名称：魔力系统
    关键词：魔力, 魔法, 施法
    类型：世界规则
    优先级：高

    内容：
    此世界的魔力来自"以太"。施法需要咒语和手势。魔力与精神力直接相关，过度使用会晕眩。魔法分为元素、治疗、召唤三大系。
    </worldbook_entry_structure>

# === 世界书的触发机制 ===

- system: |
    <trigger_mechanism>
    世界书条目何时被触发：

    1. 关键词匹配触发
       - 对话中出现关键词
       - 自动插入对应条目
       - 示例："去银月城" → 触发"银月城"条目

    2. 深度触发（Recursive Trigger）
       - 条目A被触发
       - 条目A的内容包含条目B的关键词
       - 条目B也被触发
       - 示例："银月城"条目提到"水晶塔" → 触发"水晶塔"条目

    3. 永久触发（Constant）
       - 某些条目始终激活
       - 如世界基本规则
       - 不依赖关键词

    4. 条件触发（Conditional）
       - 满足特定条件时触发
       - 如"在战斗中" → 触发"战斗规则"

    触发控制：
    - 避免过度触发（token消耗）
    - 设置触发上限（如最多5个条目）
    - 优先触发高优先级条目
    </trigger_mechanism>

# === 设定冲突处理 ===

- system: |
    <conflict_resolution>
    如何处理不同来源的设定冲突：

    情况1：角色卡 vs 世界书
    角色卡说：艾琳娜25岁
    世界书说：艾琳娜27岁
    解决：采用角色卡的"25岁"（角色卡优先）

    情况2：场景 vs 世界书
    世界书说：银月城是和平的
    当前场景说：银月城正被攻击
    解决：采用场景的"正被攻击"（场景优先）

    情况3：世界书内部冲突
    条目A说：魔法需要咒语
    条目B说：高级魔法师可以无咒施法
    解决：
    - 如果是互补（不矛盾），两者都保留
    - 如果是冲突，检查优先级
    - 优先级相同时，采用更具体的

    情况4：世界书 vs 已发生剧情
    世界书说：X国和Y国敌对
    但剧情中已经和解了
    解决：
    - 优先尊重已发生的剧情
    - 更新世界书（如果可能）
    - 或添加"曾经敌对，现已和解"

    处理原则：
    - 优先级高的覆盖低的
    - 已发生的剧情不可逆转
    - 尽量调和而非替换
    - 必要时向用户确认
    </conflict_resolution>

# === 世界书的分类组织 ===

- system: |
    <worldbook_organization>
    如何组织大量世界书条目：

    分类1：按类型
    - 地点.txt
    - 人物.txt
    - 物品.txt
    - 事件.txt
    - 规则.txt

    分类2：按地区
    - 北方王国.txt
    - 南方联邦.txt
    - 东部帝国.txt
    - 西部荒野.txt

    分类3：按重要性
    - 核心设定.txt（永久激活）
    - 常用设定.txt（高优先级）
    - 补充设定.txt（低优先级）

    分类4：按时间线
    - 古代历史.txt
    - 近代事件.txt
    - 当前状态.txt
    - 未来预言.txt

    命名规范：
    - 使用有意义的文件名
    - 添加前缀标识类型：[地点]银月城.txt
    - 添加优先级标识：[高]魔力系统.txt
    - 保持一致性
    </worldbook_organization>

# === 世界书的编写原则 ===

- system: |
    <writing_principles>
    编写世界书条目的最佳实践：

    1. 简洁性
       - 每个条目50-200字
       - 只写核心信息
       - 避免冗长描述
       ❌ "银月城是一座非常美丽的城市，有着悠久的历史..."
       ✅ "银月城，王国首都，人口50万，以水晶塔著名。"

    2. 客观性
       - 陈述事实而非感受
       - 避免主观评价
       ❌ "艾琳娜是个很棒的人"
       ✅ "艾琳娜，魔法学院教授，专长元素魔法"

    3. 可触发性
       - 包含明确的关键词
       - 关键词要自然出现在对话中
       ❌ 关键词：xhy_city_001（不会自然触发）
       ✅ 关键词：银月城, 首都（会自然触发）

    4. 一致性
       - 数字要精确（不要今天说50万，明天说100万）
       - 描述要统一（不要矛盾）
       - 定期检查和更新

    5. 层次性
       - 核心条目：简要
       - 扩展条目：详细
       - 避免在一个条目中堆砌所有信息

    6. 动态性
       - 世界书可以随剧情更新
       - 添加"时间戳"或"版本"
       - 示例："[最新]银月城：战后重建中"
    </writing_principles>

# === 世界书的Token优化 ===

- system: |
    <token_optimization>
    如何减少世界书的Token消耗：

    策略1：条件激活
    - 不要所有条目都永久激活
    - 只在需要时触发
    - 设置触发上限

    策略2：压缩描述
    - 使用简洁语言
    - 删除废话
    - 用表格或列表

    压缩前：
    "银月城是王国的首都，这座城市位于美丽的月光湖畔，城市中居住着大约50万人口。"

    压缩后：
    "银月城：王国首都，月光湖畔，人口50万。"

    策略3：分级加载
    - 第一次触发：加载简要信息
    - 深入讨论：加载详细信息
    - 示例：
      简版：银月城，首都，50万人
      详版：银月城位于月光湖畔，建于500年前...

    策略4：合并相关条目
    - 避免过度分散
    - 相关信息可以放在一起
    - 示例：把"银月城"和"月光湖"合并

    策略5：使用引用
    - 避免重复描述
    - 用"参见XXX条目"
    - 示例："水晶塔位于银月城中心。详见[银月城]条目。"
    </token_optimization>

# === 世界书与AI的交互 ===

- system: |
    <ai_interaction>
    AI如何使用世界书信息：

    1. 自动引用
       - 对话提到关键词
       - AI自动参考世界书
       - 无需用户手动输入

    2. 保持一致性
       - AI的描述应与世界书一致
       - 不应编造冲突信息
       - 不确定时优先世界书

    3. 扩展创作
       - 世界书提供框架
       - AI在框架内自由创作
       - 不违背核心设定

    4. 动态更新
       - AI可以建议更新世界书
       - 剧情重大变化时提醒用户
       - 用户确认后更新

    示例交互：
    用户："我们去银月城吧。"
    [触发"银月城"条目]
    AI："好的。银月城位于月光湖畔，从这里出发需要三天路程。你打算怎么去？"
    [AI结合世界书信息（位置）和自由创作（路程时间）]
    </ai_interaction>

# === 使用建议 ===

- system: |
    <usage_tips>
    1. 世界书适合复杂世界观的长期RP
    2. 简单对话通常不需要
    3. 条目数量建议：10-50个（过多难管理）
    4. 定期审查和更新条目
    5. 重要设定用高优先级
    6. 配合摘要机制使用效果更佳
    7. 记录设定变化的时间线
    </usage_tips>

# === 注意事项 ===

- system: |
    <caution>
    1. 世界书不是万能的
       - 不能代替good角色设定
       - 不能代替剧情规划

    2. Token消耗问题
       - 过多条目会消耗大量token
       - 需要平衡详细程度和消耗

    3. 维护成本
       - 需要定期更新
       - 需要检查一致性
       - 需要管理冲突

    4. 技术限制
       - 依赖平台支持（SillyTavern, RisuAI等）
       - 不同平台功能可能不同
       - 需要了解平台的世界书语法
    </caution>
