# 摘要机制 - Summary Mechanism
# 用途：长对话的上下文管理和记忆压缩
# 推荐度：⭐⭐⭐⭐

# === 摘要机制说明 ===

- system: |
    <summary_mechanism>
    摘要机制用于管理长对话的上下文：

    核心功能：
    1. 压缩历史对话
    2. 保留关键信息
    3. 节省token消耗
    4. 维持长期记忆

    工作原理：
    - 定期生成对话摘要
    - 摘要替代原始对话历史
    - 保留最近N轮完整对话
    - 旧对话仅保留摘要

    适用场景：
    - 长期角色扮演
    - 多轮剧情创作
    - 需要保持一致性的长对话
    - Token有限但对话很长

    Token节省：
    - 可节省50-80%的历史token
    - 但摘要生成本身也消耗token
    </summary_mechanism>

# === 基础摘要格式 ===

- system: |
    <summary_basic_format>
    基础摘要应包含的内容：

    <summary>
    【时间线】第${N}轮对话

    【场景】
    - 地点：${当前地点}
    - 时间：${时间}
    - 在场角色：${角色列表}

    【角色状态】
    - ${角色1}：${状态/情绪/位置}
    - ${角色2}：${状态/情绪/位置}

    【已发生事件】
    1. ${事件1}
    2. ${事件2}
    3. ${事件3}

    【关键对话】
    - ${重要对话摘录}

    【未解决问题】
    - ${悬而未决的事}

    【下一步方向】
    - ${预期发展}
    </summary>

    原则：
    - 只记录事实，不记录"可能"
    - 关注可观测的行为和对话
    - 省略无关紧要的细节
    - 保留影响后续剧情的信息
    </summary_basic_format>

# === 分层摘要系统 ===

- system: |
    <tiered_summary_system>
    对于超长对话，使用分层摘要：

    【一级摘要】（每10轮生成）
    - 简要记录10轮内的主要事件
    - 100-200字

    【二级摘要】（每50轮生成）
    - 整合5个一级摘要
    - 提炼核心剧情线
    - 200-300字

    【三级摘要】（每100轮生成）
    - 整合2个二级摘要
    - 提炼关键转折点
    - 300-500字

    示例结构：
    <summary level="3">
    【章节】第1-100轮
    【主线】${主要剧情发展}
    【转折】${关键转折点}
    【当前状态】${结束时的状态}
    </summary>

    <summary level="2">
    【章节】第101-150轮
    ${详细一些的摘要}
    </summary>

    <summary level="1">
    【最近】第151-160轮
    ${最详细的摘要}
    </summary>

    + 最近3轮完整对话
    </tiered_summary_system>

# === 摘要触发时机 ===

- system: |
    <summary_triggers>
    何时生成摘要：

    1. 定期触发
       - 每10轮对话生成一次
       - 每达到N个token生成一次

    2. 事件触发
       - 场景切换时
       - 重大事件发生后
       - 长时间跨度后（如"第二天"）

    3. 手动触发
       - 用户要求生成摘要
       - 用户说"总结一下"

    4. 自动触发
       - Context接近上限时
       - 性能下降时

    建议：
    - 短对话（<10轮）：不需要
    - 中等对话（10-50轮）：简单摘要
    - 长对话（>50轮）：分层摘要
    </summary_triggers>

# === 摘要的显示控制 ===

- system: |
    <summary_display_control>
    控制摘要何时显示给用户：

    方案A：始终隐藏（推荐）
    - 摘要仅供系统内部使用
    - 用户看到的是无摘要的对话
    - 通过正则表达式过滤<summary>标签

    方案B：可选显示
    - 默认隐藏
    - 用户要求时显示
    - 用命令切换："显示摘要" / "隐藏摘要"

    方案C：智能显示
    - 前N楼不显示（沉浸期）
    - 超过N楼后显示（避免混乱）
    - 示例：前10楼隐藏，10楼后显示

    实现方式（SillyTavern）：
    使用正则表达式：
    - 匹配：<summary>.*?</summary>
    - 替换：空字符串（隐藏）
    - 或替换：[摘要]（简单显示）
    </summary_display_control>

# === 摘要的更新策略 ===

- system: |
    <summary_update_strategy>
    如何更新摘要：

    1. 累积式（推荐）
       - 保留旧摘要
       - 新摘要追加
       - 形成时间线

    2. 覆盖式
       - 新摘要替换旧摘要
       - 仅保留最新状态
       - 节省token但丢失历史

    3. 合并式
       - 定期合并多个摘要
       - 提取共同要点
       - 压缩冗余信息

    示例（累积式）：
    <summary time="第1-10轮">...</summary>
    <summary time="第11-20轮">...</summary>
    <summary time="第21-30轮">...</summary>

    示例（覆盖式）：
    <summary current="true">
    包含全部历史的压缩版
    </summary>
    </summary_update_strategy>

# === 关键信息提取规则 ===

- system: |
    <key_info_extraction>
    摘要应该保留什么：

    必须保留：
    1. 角色关系变化
       - 从陌生到熟悉
       - 从朋友到恋人
       - 从合作到对立

    2. 关键承诺/约定
       - "明天见"
       - "我会保护你"
       - "答应我..."

    3. 秘密/真相揭露
       - 身份暴露
       - 隐藏信息揭示

    4. 物品/道具
       - 获得了什么
       - 失去了什么

    5. 位置/环境变化
       - 从A地到B地
       - 环境状态改变

    可以省略：
    1. 日常寒暄
    2. 重复的行为
    3. 无关紧要的细节
    4. 已解决的临时问题

    提取技巧：
    - 问自己：这个信息会影响后续吗？
    - 如果答案是"会"，就保留
    - 如果答案是"不会"，就省略
    </key_info_extraction>

# === 摘要质量检查 ===

- system: |
    <summary_quality_check>
    检查摘要是否合格：

    □ 是否包含必要的场景信息？
    □ 是否记录了角色当前状态？
    □ 是否列出了主要事件？
    □ 是否保留了关键对话？
    □ 是否指出了未解决的问题？
    □ 是否简洁（避免冗长）？
    □ 是否客观（避免主观解读）？
    □ 是否准确（符合实际发生的事）？
    □ 是否有用（能帮助后续创作）？

    不合格的摘要示例：
    ❌ "他们聊了很久，很开心。"（过于模糊）
    ❌ "A说了XXX，B说了XXX，C说了XXX..."（太啰嗦）
    ❌ "他们的关系变得微妙了。"（太抽象）

    合格的摘要示例：
    ✅ "场景：咖啡厅。A向B表白，B说需要时间考虑。两人约定三天后见面。"
    </summary_quality_check>

# === 与变量系统结合 ===

- system: |
    <summary_with_variables>
    使用变量存储摘要：

    初始化：
    {{setvar::summary1::<summary>}}
    {{setvar::summary2::</summary>}}

    使用时赋值：
    {{setvar::summary1::<summary>}}
    {{setvar::summary2::
    【第1-10轮】
    场景：...
    事件：...
    </summary>}}

    在prompt中调用：
    {{getvar::summary1}}
    ${摘要内容会被插入}
    {{getvar::summary2}}

    优点：
    - 模块化管理
    - 易于开关
    - 动态更新

    示例：
    <system>
    {{getvar::summary_opening}}

    以下是历史对话摘要：
    ${自动插入摘要内容}

    {{getvar::summary_closing}}

    [最近3轮完整对话]
    ${原始对话}
    </system>
    </summary_with_variables>

# === 摘要模板库 ===

- system: |
    <summary_templates>
    不同类型对话的摘要模板：

    1. 角色扮演型
    <summary>
    【关系】${角色间关系}
    【地点】${当前地点}
    【状态】${各角色状态}
    【事件】${发生了什么}
    【情感】${情感变化}
    </summary>

    2. 剧情创作型
    <summary>
    【章节】${章节名}
    【主线】${主要剧情}
    【支线】${次要剧情}
    【伏笔】${埋下的伏笔}
    【待续】${未解之谜}
    </summary>

    3. 问答咨询型
    <summary>
    【已解决】${已回答的问题}
    【进行中】${当前讨论的话题}
    【待处理】${未来要讨论的}
    </summary>

    4. 技术讨论型
    <summary>
    【问题】${核心问题}
    【方案】${讨论的方案}
    【决定】${最终决定}
    【行动】${下一步行动}
    </summary>

    根据对话类型选择合适的模板。
    </summary_templates>

# === 使用建议 ===

- system: |
    <summary_usage_tips>
    1. 不是所有对话都需要摘要
    2. 短对话（<10轮）通常不需要
    3. 长对话（>50轮）强烈建议使用
    4. 定期生成，不要拖到最后
    5. 摘要要简洁、准确、有用
    6. 可以配合正则表达式隐藏显示
    7. 根据token预算调整摘要详细程度
    8. 重大事件后立即更新摘要
    </summary_usage_tips>

# === 注意事项 ===

- system: |
    <summary_caution>
    1. 摘要本身也消耗token
    2. 频繁生成摘要可能得不偿失
    3. 摘要质量影响后续创作
    4. 不要在摘要中编造未发生的事
    5. 保持摘要的客观性
    6. 定期检查摘要是否准确
    </summary_caution>
